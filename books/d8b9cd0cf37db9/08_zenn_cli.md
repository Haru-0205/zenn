---
title: Zenn_CLIについて
---

# Zenn CLIとは

この記事を書くために使用しているNPMパッケージです。
何だかんだでこれが使えないと話にならないですね。
まあNodeがからむと環境構築がめんどくさくなります。

今回は、すでに他の端末で作成したリポジトリがあるので、これを用いてnixパッケージ化します。

# node2nix

今回はこの「node2nix」というパッケージを使用します。

https://github.com/svanderburg/node2nix

これは、nodeのpackage.jsonからnix式を生成するパッケージです。
使いかたは至ってかんたんです。

1. nix化したいパッケージのルートへ移動
2. package.jsonがあるか確認
3. `nix-shell -p node2nix`
4. `node2nix package.json`

これで、`default.nix` `node-env.nix` `node-packages.nix`の3つのファイルが生成されます。

`nix-shell -p <package>`で、そのパッケージが導入されたshellを立ちあげることができます。

ただ、このままだとうまくいかないので、一部を書き換えます。

```diff nix:default.nix
# This file has been generated by node2nix 1.11.1. Do not edit!

{pkgs ? import <nixpkgs> {
    inherit system;
- }, system ? builtins.currentSystem, nodejs ? pkgs."nodejs_12"}:
+ }, system ? builtins.currentSystem, nodejs ? pkgs."nodejs_22"}:
let
    nodeEnv = import ./node-env.nix {
        inherit (pkgs) stdenv lib python2 runCommand writeTextFile writeShellScript;
        inherit pkgs nodejs;
        libtool = if pkgs.stdenv.isDarwin then pkgs.cctools or pkgs.darwin.cctools else null;
    };
in
import ./node-packages.nix {
    inherit (pkgs) fetchurl nix-gitignore stdenv lib fetchgit;
    inherit nodeEnv;
}
```

"Do not edit!"を無視してるというのはおいといて、このままだとnode.jsのバージョンが古すぎてビルドが通らないので、node.jsのバージョンを最新のLTS版であるNode.js 22(nodejs_22)に上げておきます。私の場合はこれでビルドが通りました。

# shell.nix

そして、この`shell.nix`への組み込みも結構大変なんですよね...

結論だけいうと、以下のようになりました。

```nix:shell.nix
{ 
    pkgs ? import <nixpkgs> {
        inherit system;
    }, system ? builtins.currentSystem}:
let
    nodeDependencies = (pkgs.callPackage ./default.nix {}).nodeDependencies;
in
pkgs.mkShell {
    pure = true;
    buildInputs = with pkgs; [
        git
        nodejs_22
        nodePackages.pnpm
    ];
    shellHook = ''
        ln -s ${nodeDependencies}/lib/node_modules ./node_modules
        export PATH="${nodeDependencies}/bin:$PATH"
        echo "Node.js Develop Environment is Activated"
    '';
}
```

これは、簡単にいうと`\nix\store`配下にあるnodeのパッケージたちのシンボリックリンクを`node_modules`配下に貼ることでnpmがパッケージを使えるようにしている、ということです。
pnpmがちょうどこのようなやりかたをしているので、今回パッケージマネージャーには`pnpm`を採用しました。

これで、`nix-shell`するだけですでにパッケージの導入までされているnode環境を立ち上げることができます。
